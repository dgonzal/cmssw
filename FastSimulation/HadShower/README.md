# Introduction

The package FastSimulation/HadShower contains a fast model for hadronic showers in the CMS calorimeter, loosely based on GFLASH [1]. This package is a re-implementation of the class HDShower in the package /FastSimulation/ShowerDevelopment

# Installation

## Collect the package

```
cmsrel CMSSW_A_B_C  # e.g. CMSSW_7_6_0_pre4
cd CMSSW_A_B_C/src
cmsenv
git cms-merge-topic lveldere:fastsim-hadshower
```

## Compile outside CMSSW

```
# setup CMSSW in order to use correct compiler, root version, etc.
cd CMSSW_A_B_C/src
cmsenv
# then compile
cd FastSimulation/HadShower/test
make # use option -j 8 to gain speed
```

## Run outside CMSSW

```
# setup CMSSW in order to use correct interpreter, root version, etc.
cd CMSSW_A_B_C/src
cmsenv
# and run
./bin/test_start                      # test the generation of the shower starting point
./bin/test_stepFactory                # test the creation of shower steps
./bin/test_shapeParametersGenerator   # test the generation of shower shape parameters
./bin/test_shape                      # comprehensive test of shower generation
```

## Compile inside CMSSW

under development

## Run inside CMSSW

under development



# Description of the shower model

## Overview

The modeling of a shower initiated by a hadron has the following ingredients:
  1. the modeling of the **shower start**, where the shower start is the first inelastic interaction of the hadron in the calorimeter
  2. the definition of **shower steps** along the shower's direction to define the resolution by which to model the shower
  3. the modeling of the expected **energy distribution** of the shower
  4. the sampling of the expected *energy distribution** of the shower to model the shower's *energy depositions*

## Units and coordinates

Energy is expressed in GeV.

Distance is mostly expressed in the unit of interaction length.
Alternative units are centimeter and radiation lenght.
Whenever one or another variable is expressed in these alternative units,
this is made clear in the code by letting the variable name end with respectively InCm or InRadLen.

TODO: provide references to proper definitions of interaction lenght and radiation length

The direction along the shower axis is named the longitudinal direction.
The plain perpendicular to the shower axis is named the transverse plain.
The symbol r is used for the distance between a point and the shower axis.
The symbol z is used for coordinates along the shower axis,
taking as origin the piont where the particle enters the calorimeter.

## Calorimeter material

It is assumed that the trajectoy of any particle that hits the calorimeter first passes through ECAL, 
then a gap between ECAL and HCAL, and finally HCAL.
For any given particle the calorimeter is fully described by providing the distance the particle's trajectory 
travels through ECAL, the gap and HCAL.

Material properties are stored in objects of type hadshower::Material.

## Shower start

Since the unit of interaction lenght is used,
the distribution of the distance particles travel through the calorimeter until undergoing an inelastic interaction 
is modeled by a simple exponential with mean 1 (remember the unit is interaction length).

This model is implemented in the class hadshower::StartGenerator
and the code test/test_start.C illustrates the usage of this class.

## Shower steps

Space is divided along the shower direction into so called shower steps.
The first step starts at the shower start.
The part of the trajectory after that point that runs through ECAL defines one step,
and the part that runs through the gap defines another step.
The part of the trajectoy in hcal is divided into steps with equal, fixed size,
until a certain maximum number of steps is reached.

Shower steps are stored in containers of type hadshower::Step.
hadshower::Step::depth stores the distance between the shower start and the start of the step.
hadshower::Step::size stores the size (thickness) of the step.

For a given shower, the shower steps are created by the class hadshower::StepFactory.
See test/test_stepFactory.C for an example illustrating the usage of hadshower::StepFactory.

## Expected energy distribution

The expected longitudinal (transverse) energy distribution is modeled according to eq. 9 (7) of [1].
The parameter values are drawn randomly around mean values obtained from FullSim.
When the shower starts in ECAL, the longitudinal energy distribution is altered by 
first multiplying the expected energy in ECAL with a correction factor,
and subsequently normalizing the energy fractions in all steps.
The values of all involved parameters follow distributions
with widths and shapes that are not extremely well motivated (as far as understood).

For a given shower, the parameter values are generated by the class hadshower::ShapeParametersGenerator
and stored in an object of type hadshower::ShapeParameters.
See test/test_shapeParametersGenerator.C for an example illustrating the usage of hadshower::ShapeParametersGenerator.

## Energy depositions

Energy depositions are drawn from the expected energy distribution.
The depositions have all (nearly) the same energy and are drawn from the energy distribution in such fashion
that the energy of the deposition in each step exactly adds up to the expected energy in that step.
This implies that FastSimulation/HadShower provides no model at all for a whole range of fluctuations that take place in actual showers.

Energy depositions are generated by the class hadshower::Shape.
See test/test_shape.C for an example illustrating the usage of this class.

# Not in this package

HadShower provides no model for the shower energy response.
(The shower energy response will be modeled in the class CalorimeteryManager, once it interfaces FastSimulation/HadShower)

HadShower produces no SimHits.
This avoids dependence on complicated geometry classes.
(SimHits will be produced in the class CalorimeteryManager, once it interfaces FastSimulation/HadShower)

# Open questions

Can we model the shower energy response in a more fundamental way,
e.g. by actually modeling sampling fluctuations.
See section 3.2 of [2]

In the same context, would it be better to let shower steps in hcal follow the segmentation of hcal?

Is the ratio of energy deposited in active material over energy deposited in passive material constant along the longitudinal direction?

How to better model all shower fluctuations?

...

# To do

Handle the energy dependence of the interaction length when modeling the shower start
(In HDShower this is taken care of by the mip-fraction)

# References

[1] Nuclear Instruments and Methods in Physics Research A290 (1990) 469-488

[2] http://arxiv.org/abs/hep-ex/0001020
